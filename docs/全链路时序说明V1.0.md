# 全链路时序说明（文字版）

本文以文字时序的形式，对系统中**上行遥测链路**与**下行控制链路**进行完整描述，
用于统一设备端、网关、中转服务器、消息队列、后端服务及前端应用之间的交互理解。

---

## 一、系统参与角色

- 设备（Device）  
  环境监测设备或执行机构

- 设备网关（Gateway）  
  负责设备接入与通信转发

- MQTT Broker（Mosquitto）  
  负责 MQTT 消息转发

- 中转服务器（Bridge Service）  
  实现 MQTT ⇄ AMQP 协议转换

- 消息队列（RabbitMQ）  
  上下行消息缓冲与解耦

- 后端服务（Backend Service）  
  数据处理、入库与控制逻辑

- 前端应用（Web UI）  
  数据展示与人工控制界面

---

## 二、上行链路时序（环境遥测）

### 场景说明
设备周期性上报环境监测数据（如温度、湿度、粒子浓度等）。

---

### 时序步骤

```text
1. 设备采集环境数据
   Device:
     - 读取传感器
     - 生成 telemetry 消息

2. 设备通过 WebSocket 上报数据
   Device → Gateway (WebSocket):
     {
       msg_type: "telemetry",
       device_id,
       timestamp,
       payload
     }

3. 网关转发至 MQTT Broker
   Gateway → MQTT Broker (MQTT Publish):
     - topic: uplink/telemetry
     - payload: 原始 JSON

4. 中转服务器订阅 MQTT 消息
   Bridge Service:
     - 订阅 uplink/# 主题
     - 接收遥测消息

5. 中转服务器转换协议并投递队列
   Bridge Service → RabbitMQ:
     - exchange: default
     - routing_key: "uplink.queue"
     - message body: telemetry JSON

6. 后端服务消费上行队列
   Backend Service:
     - 消费 uplink.queue
     - 解析 telemetry 消息

7. 数据写入时序数据库
   Backend Service → InfluxDB:
     - 写入遥测数据（append-only）

8. 更新设备运行状态（可选）
   Backend Service → MySQL:
     - 更新 device.last_seen_at

9. 前端实时订阅（可选）
   Backend Service → Web UI (WebSocket):
     - 推送最新遥测数据
