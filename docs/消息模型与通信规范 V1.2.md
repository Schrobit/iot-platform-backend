
# 消息模型与通信规范 V1.2

## 1. 文档目的

本文档用于规范 **设备、网关（Gateway）、中转服务器（MQTT–AMQP Bridge）、后端系统** 之间的消息交互格式，统一消息模型，明确系统边界，支撑后续功能扩展（设备直连、ACK、幂等等）。

**本版本目标（V1.2）：**

* 最小可行（MVP）
* 与数据库模型强一致（`device_id` / `gateway_id`）
* 支持「设备经网关」与「设备直连（后续再拓展）」两种模式
* 不引入复杂确认、重试、幂等机制
* 可直接用于开发、联调、验收

---

## 2. 总体设计原则

1. **统一 JSON 数据格式**
2. **统一字段命名规范（snake_case）**
3. **消息体与通信协议解耦**
4. **时间统一使用 ISO 8601（UTC）**
5. **业务语义由后端解释**
6. **中转服务器不参与业务逻辑**
7. **向前兼容，允许字段扩展**

---

## 3. 系统角色说明

| 角色               | 说明          |
| ---------------- | ----------- |
| 设备（Device）       | 传感器或执行器     |
| 网关（Gateway）      | 设备的通信代理（可选） |
| MQTT Broker      | 设备/网关通信通道   |
| MQTT–AMQP Bridge | 协议中转服务      |
| RabbitMQ         | 后端消息队列      |
| Backend          | 业务处理与控制     |
| InfluxDB         | 时序数据存储      |

---

## 4. 统一消息 Envelope 结构

**所有业务消息必须遵循以下 Envelope 结构：**

本版本不定义 event 类型的具体语义，仅保留字段以便后续扩展。

```json
{
  "msg_type": "telemetry | command | event",
  "device_id": 1,
  "gateway_id": 1,
  "timestamp": "2025-01-01T10:05:00Z",
  "payload": { }
}
```

### 字段说明

| 字段         | 类型            | 必填 | 说明                                   |
| ---------- | ------------- | -- | ------------------------------------ |
| msg_type   | string        | 是  | 消息类型                                 |
| device_id  | number        | 是  | MySQL 中 `device.id`                  |
| gateway_id | number | null | 否  | MySQL 中 `gateway.id`，设备直连时可省略或为 null |
| timestamp  | string        | 是  | ISO 8601 UTC 时间                      |
| payload    | object        | 是  | 业务负载                                 |

### gateway_id 说明

* **设备通过网关通信**：
  `gateway_id` 必须存在
* **设备直连 MQTT（未来扩展）**：
  `gateway_id = null` 或字段缺省
* 后端必须支持两种情况

---

## 5. 上行消息：遥测数据（Telemetry）

### 5.1 使用场景

* 设备周期性上报监测数据
* 数据最终写入 InfluxDB
* 可经网关或直连上报

### 5.2 示例（经网关上报）

```json
{
  "msg_type": "telemetry",
  "device_id": 1,
  "gateway_id": 1,
  "timestamp": "2025-01-01T10:05:00Z",
  "payload": {
    "value": 22.3,
    "unit": "℃"
  }
}
```

### 5.3 示例（设备直连（后续再拓展））

```json
{
  "msg_type": "telemetry",
  "device_id": 1,
  "timestamp": "2025-01-01T10:05:00Z",
  "payload": {
    "value": 22.3,
    "unit": "℃"
  }
}
```

### 5.4 payload 约定

| 字段    | 类型     | 说明       |
| ----- | ------ | -------- |
| value | number | 监测值      |
| unit  | string | 单位（展示用途） |

> 数据语义由 `device.type` 决定（temperature / humidity / particle 等）。

---

## 6. 下行消息：控制命令（Command）

### 6.1 使用场景

* 后端向设备下发控制指令
* 当前版本不要求设备回执

### 6.2 示例（经网关下发）

```json
{
  "msg_type": "command",
  "device_id": 1,
  "gateway_id": 1,
  "timestamp": "2025-01-01T10:05:00Z",
  "command": "set_power",
  "payload": {
    "state": "on"
  }
}
```

### 6.3 示例（设备直连（后续再拓展））

```json
{
  "msg_type": "command",
  "device_id": 1,
  "timestamp": "2025-01-01T10:05:00Z",
  "command": "set_power",
  "payload": {
    "state": "on"
  }
}
```

### 6.4 字段补充说明

| 字段      | 类型     | 必填 | 说明   |
| ------- | ------ | -- | ---- |
| command | string | 是  | 命令名称 |
| payload | object | 是  | 命令参数 |

---

## 7. MQTT Topic 规范（通信层）

### 7.1 经网关通信

#### 上行（设备 → 网关 → MQTT）

```
uplink/gateway/{gateway_id}/device/{device_id}
```

#### 下行（MQTT → 网关 → 设备）

```
downlink/gateway/{gateway_id}/device/{device_id}
```

---

### 7.2 设备直连 MQTT（后续再拓展）

#### 上行

```
uplink/device/{device_id}
```

#### 下行

```
downlink/device/{device_id}
```

---

### 7.3 说明

* Topic 仅负责路由
* JSON payload 承载完整业务语义
* 后端与 InfluxDB 不依赖 topic 结构

---

## 8. RabbitMQ 消息规范（AMQP）

### 8.1 队列定义

| 队列             | 用途     |
| -------------- | ------ |
| uplink.queue   | 上行遥测数据 |
| downlink.queue | 下行控制命令 |

### 8.2 消息体

RabbitMQ 中的消息体 **与 MQTT 消息体完全一致**，不额外封装：

```json
{
  "msg_type": "telemetry",
  "device_id": 1,
  "gateway_id": 1,
  "timestamp": "2025-01-01T10:05:00Z",
  "payload": {
    "value": 22.3,
    "unit": "℃"
  }
}
```

---

## 9. MQTT–AMQP Bridge 职责边界

### Bridge 必须做的事

* MQTT ↔ AMQP 协议转换
* Topic 与队列的映射
* JSON 解析与基础校验
* 日志记录

### Bridge 禁止做的事

* 设备或用户鉴权
* 业务逻辑判断
* 数据存储
* 命令权限校验

---

## 10. 版本说明

| 版本       | 说明                        |
| -------- | ------------------------- |
| V1.0     | 初始草案                      |
| V1.1     | 使用 device_id / gateway_id |
| **V1.2** | gateway_id 设为可选，支持设备直连    |

---

## 11. 后续可扩展方向（不在本版本实现）

* `msg_id`（幂等 / 全链路追踪）
* 命令 ACK / 执行状态
* 批量遥测
* QoS / 重试机制
* 设备影子同步

---

**本文档为当前系统消息模型的唯一权威定义。**
所有模块（设备、网关、Bridge、Backend）必须遵循本规范。
