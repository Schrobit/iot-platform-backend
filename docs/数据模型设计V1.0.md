# 数据模型设计（初期版本 · 不引入设备影子）

> 2025-12-27 created by Schrobit

## 1. 文档目的

本文档用于说明系统**初期实现阶段**的数据模型设计方案，
明确系统中各类数据的存储位置、数据职责划分以及设计边界。

在当前阶段，系统目标是**跑通“监测 + 人工控制”的完整闭环**，
因此在数据模型设计上遵循以下原则：

- 优先保证系统结构清晰、实现简单
- 避免引入非必要的状态同步与复杂抽象
- 为后续功能扩展预留空间，但不提前实现

---

## 2. 数据存储总体设计

系统采用**关系型数据库 + 时序数据库**的双存储架构：

| 数据类型 | 存储系统 | 说明 |
|------|------|------|
| 用户与权限 | MySQL | 结构化数据，需事务一致性 |
| 资产与拓扑 | MySQL | 洁净室、网关、设备等 |
| 控制命令记录 | MySQL | 操作审计与追溯 |
| 设备运行状态 | MySQL | 在线状态、最近通信时间 |
| 遥测历史数据 | InfluxDB | 高频时间序列数据 |

在初期阶段，系统**不引入设备影子（Device Shadow）机制**，
当前设备状态通过 MySQL 与 InfluxDB 联合获取。

---

## 3. 关系型数据库（MySQL）数据模型

### 3.1 用户数据模型

#### 用户（User）

**职责**
- 表示系统操作主体
- 用于登录认证与权限区分

**核心属性**
- 用户名
- 加密后的密码
- 用户角色（staff / admin）
- 启用状态

**设计说明**
- staff 用户仅具备查看权限
- admin 用户可执行控制操作
- 不进行更细粒度权限建模

---

### 3.2 洁净室数据模型

#### 洁净室（Cleanroom）

**职责**
- 作为环境监测与控制的逻辑管理单元
- 对设备进行区域归属管理

**核心属性**
- 洁净室名称
- 扩展属性（meta）
- 启用状态

**设计说明**
- 洁净室用于逻辑划分，不建模物理建筑结构
- 洁净室不直接参与控制逻辑计算

---

### 3.3 网关数据模型

#### 网关（Gateway）

**职责**
- 作为设备与平台之间的通信中介
- 维护设备接入与在线状态

**核心属性**
- 网关名称 / 序列号
- 最近心跳时间
- 扩展属性（meta）

**设计说明**
- 网关本身不参与业务决策
- 网关与洁净室之间为多对多关系

---

### 3.4 网关-洁净室关系模型

#### 网关-洁净室关联（Gateway–Cleanroom）

**职责**
- 描述网关对洁净室的服务或覆盖关系

**关系特征**
- 一个网关可服务多个洁净室
- 一个洁净室可由多个网关覆盖

**设计说明**
- 使用独立关联表表示多对多关系
- 便于后续扩展覆盖范围或部署信息

---

### 3.5 设备数据模型

#### 设备（Device）

**职责**
- 系统中最小的监测或控制单元
- 所有数据采集与控制操作的核心对象

**核心属性**
- 设备名称 / 序列号
- 设备类型（单变量）
- 所属洁净室
- 所属网关
- 单位信息
- 上下行通信主题
- 最近通信时间
- 启用状态

**单变量建模原则**
- 一个设备仅对应一个物理量或控制点
- 温度与湿度在系统中拆分为两个逻辑设备
- 有利于数据模型简化与控制逻辑清晰化

**运行状态说明**
- 设备在线状态通过 `last_seen_at` 推断
- 不在 MySQL 中维护实时数值

---

### 3.6 控制命令数据模型

#### 控制命令记录（Command Log）

**职责**
- 记录系统向设备下发的控制操作
- 提供操作审计与行为追溯能力

**核心属性**
- 目标设备
- 命令名称
- 命令参数
- 操作用户
- 操作时间

**设计说明**
- 当前阶段不追踪命令执行状态
- 不维护命令 ACK 或失败信息
- 后续可通过扩展字段或新增表支持

---

## 4. 时序数据库（InfluxDB）数据模型

### 4.1 遥测数据模型

#### 测量（Measurement）：telemetry

**职责**
- 存储设备上报的历史环境数据
- 支持趋势分析、区间查询与可视化

**典型字段**
- time：时间戳
- value：测量值

**典型标签（Tags）**
- device_id
- device_type
- cleanroom_id（可选）

**设计说明**
- 所有高频采集数据仅写入 InfluxDB
- MySQL 不存储遥测历史数据
- 最新数据在需要时从 InfluxDB 查询

---

## 5. 当前状态获取方式说明

在不引入设备影子机制的前提下：

- 设备在线状态  
  → 通过 MySQL 中的 `last_seen_at` 判断

- 设备当前数值  
  → 查询 InfluxDB 中对应设备的最新一条遥测数据

该方式在设备规模较小、查询频率可控的情况下具有良好的可行性。

---

## 6. 数据模型边界说明

为控制系统复杂度，当前阶段明确不做以下内容：

- 不在 MySQL 中缓存实时测量值
- 不维护设备期望状态与实际状态对齐
- 不进行自动控制或策略决策建模
- 不进行遥测数据的生命周期管理

---

## 7. 扩展预留说明

本数据模型为后续功能扩展预留以下能力：

- 可引入设备影子机制用于状态管理
- 可扩展命令执行状态与 ACK 机制
- 可增加自动控制与策略模块

当前设计为**可演进的数据模型**，
无需大规模重构即可支持后续功能升级。

---

## 8. 小结

通过在初期阶段采用简化的数据模型设计，
系统实现了：

- 清晰的资产与权限管理
- 高效的遥测数据存储
- 可追溯的人工控制闭环

该数据模型在满足当前功能需求的同时，
为系统后续演进提供了良好的扩展基础。
